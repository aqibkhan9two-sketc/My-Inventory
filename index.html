<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard - Rubell Walmart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --success: #2ecc71;
            --bg: #f4f7fa;
            --sidebar: #1e1e2d;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg);
            color: #2d3436;
            min-height: 100vh;
        }

        /* Sidebar Logic */
        .sidebar {
            width: 260px;
            height: 100vh;
            background: var(--sidebar);
            color: #a2a3b7;
            padding: 25px;
            position: fixed;
            z-index: 1000;
            transition: 0.3s;
        }

        .sidebar h2 {
            color: white;
            font-weight: 800;
            margin-bottom: 40px;
            font-size: 22px;
        }

        .sidebar h2 span {
            color: var(--success);
        }

        .sidebar a {
            display: block;
            color: #a2a3b7;
            text-decoration: none;
            padding: 14px 18px;
            border-radius: 12px;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 15px;
        }

        .sidebar a:hover,
        .sidebar a.active {
            background: rgba(67, 97, 238, 0.15);
            color: white;
        }

        /* Logout Button Style */
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 12px;
            width: 100%;
            margin-top: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .main-content {
            margin-left: 260px;
            padding: 30px;
            transition: 0.3s;
            width: calc(100% - 260px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.03);
            border-bottom: 4px solid var(--primary);
        }

        .kpi-value {
            font-size: 24px;
            font-weight: 800;
            margin-top: 5px;
        }

        .filter-bar {
            background: white;
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 25px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }

        .filter-group {
            flex: 1;
            min-width: 150px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 700;
            color: #636e72;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #dfe6e9;
            width: 100%;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }

        .section-card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.03);
            margin-bottom: 25px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        @media (max-width: 992px) {
            .sidebar {
                width: 80px;
                padding: 15px 10px;
                text-align: center;
            }

            .sidebar h2,
            .sidebar a span,
            .logout-btn span {
                display: none;
            }

            .main-content {
                margin-left: 80px;
                width: calc(100% - 80px);
                padding: 20px;
            }
        }

        @media (max-width: 600px) {
            .sidebar {
                position: relative;
                width: 100%;
                height: auto;
                display: flex;
                overflow-x: auto;
                padding: 10px;
                margin-bottom: 10px;
            }

            .sidebar a {
                margin: 0 5px;
                white-space: nowrap;
            }

            .logout-btn {
                width: auto;
                margin-top: 0;
                margin-left: 10px;
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 15px;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .client-stock-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-radius: 12px;
            background: #f8f9fc;
            margin-bottom: 12px;
            border-left: 5px solid var(--primary);
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <h2>Rubell<span>Walmart</span></h2>
        <a href="index.html" class="active">üìä <span>Dashboard</span></a>
        <a href="stock.html">üìà <span>Live Stock</span></a>
        <a href="orders.html">üõí <span>Orders</span></a>
        <a href="purchases.html">üí∞ <span>Purchases</span></a>
        <a href="products.html">üì¶ <span>Products</span></a>
        <a href="clients.html">üë• <span>Clients</span></a>
        <a href="warehouse.html">üè† <span>Warehouses</span></a>

        <button class="logout-btn" id="logoutBtn">üö™ <span>Logout</span></button>
    </div>

    <div class="main-content">
        <h1 style="font-weight: 800; margin-bottom: 20px; font-size: clamp(20px, 4vw, 32px);">My Dashboard</h1>

        <div class="filter-bar">
            <div class="filter-group"><label>Select Client</label><select id="clientFilter">
                    <option value="all">All Clients</option>
                </select></div>
            <div class="filter-group"><label>From Date</label><input type="date" id="startDate"></div>
            <div class="filter-group"><label>To Date</label><input type="date" id="endDate"></div>
            <button onclick="location.reload()"
                style="background:var(--primary); color:white; border:none; padding:12px 20px; border-radius:10px; font-weight:600; cursor:pointer;">Reset</button>
        </div>

        <div class="stats-grid">
            <div class="kpi-card">
                <div>Revenue</div>
                <div class="kpi-value" id="topRev">$0.00</div>
            </div>
            <div class="kpi-card" style="border-color:var(--success)">
                <div>Profit</div>
                <div class="kpi-value" id="topProfit" style="color:var(--success)">$0.00</div>
            </div>
            <div class="kpi-card" style="border-color:#f39c12">
                <div>Stock Units</div>
                <div class="kpi-value" id="topUnits">0</div>
            </div>
            <div class="kpi-card" style="border-color:#9b59b6">
                <div>Orders</div>
                <div class="kpi-value" id="topOrders">0</div>
            </div>
        </div>

        <div class="section-card">
            <h3>üì¶ Client Portfolio Live Status</h3>
            <div id="clientStockList">Loading...</div>
        </div>

        <div class="dashboard-grid">
            <div class="section-card">
                <h3>üìà Profit Trends</h3>
                <div class="chart-container"><canvas id="profitBarChart"></canvas></div>
            </div>
            <div class="section-card">
                <h3>üç© Activity Analysis</h3>
                <div class="chart-container"><canvas id="activityDoughnut"></canvas></div>
            </div>
        </div>
    </div>

    <script type="module">
        // 1. Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBTxU9U4OW_xaEV3WZnSrpdM9Lal8TBN5c",
            authDomain: "my-inventory-app-4c806.firebaseapp.com",
            projectId: "my-inventory-app-4c806",
            storageBucket: "my-inventory-app-4c806.firebasestorage.app",
            messagingSenderId: "258251635272",
            appId: "1:258251635272:web:597ea77880c4ff3ef3767d"
        };

        // 2. Initialize
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // 3. SECURITY GUARD: Login check
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "login.html";
            }
        });

        // Logout Functionality
        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = "login.html";
            });
        });

        let clients = [], products = [], purchases = [], orders = [];
        let pChart = null, dChart = null;

        // Data Listeners
        onSnapshot(collection(db, 'clients'), s => {
            clients = s.docs.map(d => ({ id: d.id, ...d.data() }));
            const select = document.getElementById('clientFilter');
            // Dropdown ko sirf ek baar populate karein
            if (select.options.length <= 1) {
                clients.forEach(c => select.add(new Option(c.accountName, c.accountName)));
            }
            refresh();
        });
        onSnapshot(collection(db, 'products'), s => { products = s.docs.map(d => ({ id: d.id, ...d.data() })); refresh(); });
        onSnapshot(collection(db, 'purchases'), s => { purchases = s.docs.map(d => d.data()); refresh(); });
        onSnapshot(collection(db, 'orders'), s => { orders = s.docs.map(d => d.data()); refresh(); });

        function refresh() {
            const selClient = document.getElementById('clientFilter').value;
            const sD = document.getElementById('startDate').value;
            const eD = document.getElementById('endDate').value;

            let totalInStock = 0, totalRev = 0, totalProf = 0;
            let clientHTML = '';

            // 1. Client Portfolio Section (Stock-based Prefix Logic)
            clients.forEach(client => {
                let clientPrefix = "";
                const cName = client.accountName.toLowerCase();

                // Yahan hum define kar rahe hain ke kaunsa client kis stock prefix ko dekhega
                if (cName.includes("steller")) {
                    clientPrefix = "ST-";
                } else if (cName.includes("light house") || cName.includes("lhn")) {
                    clientPrefix = "LH-"; // Ya jo bhi aapke stock mein Light House ka prefix hai
                } else if (cName.includes("khanco")) {
                    clientPrefix = "KH-";
                }

                let cUnits = 0, cVal = 0;

                // Products ko us client ke prefix se filter karein
                products.filter(p => (p.sku || "").toUpperCase().startsWith(clientPrefix) && clientPrefix !== "").forEach(prod => {
                    const skPur = purchases.filter(pur => pur.sku === prod.sku);
                    const qIn = skPur.reduce((a, b) => a + (+b.qty || 0), 0);
                    const qOut = orders.filter(o => o.sku === prod.sku).reduce((a, b) => a + (+b.qty || 0), 0);
                    
                    const bal = qIn - qOut;
                    cUnits += bal;

                    const avgCost = qIn > 0 ? (skPur.reduce((a, b) => a + (+b.totalAmount || 0), 0) / qIn) : 0;
                    cVal += (bal * avgCost);
                });

                if (selClient === 'all' || client.accountName === selClient) {
                    totalInStock += cUnits;
                    
                    // Border color prefix ke mutabiq change hoga
                    let borderColor = "#2ecc71"; // Default Green
                    if (clientPrefix === "ST-") borderColor = "#4361ee"; // Blue
                    if (clientPrefix === "LH-") borderColor = "#e74c3c"; // Red for Light House

                    clientHTML += `
                    <div class="client-stock-item" style="border-left: 5px solid ${borderColor}">
                        <div>
                            <b style="font-size: 15px;">${client.accountName}</b>
                            <div style="font-size: 11px; color: #636e72;">Detected Prefix: ${clientPrefix}</div>
                        </div>
                        <div style="text-align:right">
                            <b style="font-size: 16px;">$${cVal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</b>
                            <div style="font-size: 12px; font-weight: 600; color: #4361ee;">${cUnits.toLocaleString()} Units</div>
                        </div>
                    </div>`;
                }
            });

            // 2. Orders & KPI Section (Waisa hi rahega)
            const fOrders = orders.filter(o => {
                const dateMatch = (!sD || o.date >= sD) && (!eD || o.date <= eD);
                if (selClient === 'all') return dateMatch;
                const nameInOrder = (o.clientName || o.client || o.accountName || "").toString().trim().toLowerCase();
                const nameToMatch = selClient.toString().trim().toLowerCase();
                return (nameInOrder === nameToMatch) && dateMatch;
            });

            const fPurchases = purchases.filter(p => (!sD || p.date >= sD) && (!eD || p.date <= eD));

            fOrders.forEach(o => {
                totalRev += (Number(o.qty || 0) * Number(o.sellPrice || 0));
                totalProf += Number(o.profit || 0);
            });

            // Updating UI
            document.getElementById('topRev').innerText = `$${totalRev.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('topProfit').innerText = `$${totalProf.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('topUnits').innerText = totalInStock.toLocaleString();
            document.getElementById('topOrders').innerText = fOrders.length;
            document.getElementById('clientStockList').innerHTML = clientHTML || '<div style="padding:10px;">No Data Found</div>';

            updateCharts(fOrders, fPurchases);
        }

        function updateCharts(fOrders, fPurchases) {
            if (pChart) pChart.destroy();
            if (dChart) dChart.destroy();

            const months = [...new Set(fOrders.map(o => o.date?.substring(0, 7)))].sort();
            const profData = months.map(m => fOrders.filter(o => o.date?.startsWith(m)).reduce((a, b) => a + Number(b.profit || 0), 0));

            pChart = new Chart(document.getElementById('profitBarChart'), {
                type: 'bar',
                data: { labels: months, datasets: [{ label: 'Profit', data: profData, backgroundColor: '#2ecc71', borderRadius: 8 }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            dChart = new Chart(document.getElementById('activityDoughnut'), {
                type: 'doughnut',
                data: {
                    labels: ['Orders Qty', 'Purchases Qty'],
                    datasets: [{ data: [fOrders.reduce((a, b) => a + (+b.qty || 0), 0), fPurchases.reduce((a, b) => a + (+b.qty || 0), 0)], backgroundColor: ['#4361ee', '#f39c12'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        document.getElementById('clientFilter').addEventListener('change', refresh);
        document.getElementById('startDate').addEventListener('change', refresh);
        document.getElementById('endDate').addEventListener('change', refresh);
    </script>
</body>

</html>
